// *** ç‹¬è‡ªé–¢æ•°å‘¼ã³å‡ºã—+ãã®ä»–ï¼ˆayaã•ã‚“ï¼‰ ***
// const { getBalance } = require("./balance");
// const { postTransfer } = require("./transfer");
// const userStatus = {};
// const { getTodayJST } = require("./date");
const { getStatement } = require("./statement");
const { replyText, replyTextWithQuickReply } = require("./lineReply");
const { getDateJSTDaysAgo } = require("./date");



// *** å±¥æ­´ä¸€è¦§ ***
if (reqMessage === "å±¥æ­´ä¸€è¦§") {
  console.log("å±¥æ­´ä¸€è¦§ãƒªã‚¯ã‚¨ã‚¹ãƒˆããŸã‚ˆ");

// ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œå±¥æ­´ã®æœŸé–“é¸æŠä¸­ã€
userStatus[userId] = {
  mode: "HISTORY_SELECT"
};

  await replyTextWithQuickReply(
    replyToken,
    "å±¥æ­´ã‚’ç¢ºèªã—ãŸã„æœŸé–“ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",
    [
      { label: "ä»Šæ—¥", text: "ä»Šæ—¥" },
      { label: "ï¼“æ—¥é–“", text: "ï¼“æ—¥é–“" },
      { label: "ä»Šé€±", text: "ä»Šé€±" },
      { label: "å¤§å®°åºœ", text: "å¤§å®°åºœ" },
    ]
  );
  return { statusCode: 200, body: "OK" };
}

// æœŸé–“é¸æŠ ("userStatusãŒHISTORY_SELECTã®å ´åˆã®ã¿ï¼‰
if (
  userStatus[userId]?.mode === "HISTORY_SELECT" &&
  ["ä»Šæ—¥", "ï¼“æ—¥é–“", "ä»Šé€±", "å¤§å®°åºœ"].includes(reqMessage)
) {
  console.log("æœŸé–“é¸æŠãƒªã‚¯ã‚¨ã‚¹ãƒˆ:", reqMessage);

  // type ã«å¤‰æ›
  let type;
  switch (reqMessage) {
    case "ä»Šæ—¥":
      type = "today";
      break;
    case "ï¼“æ—¥é–“":
      type = "3days";
      break;
    case "ä»Šé€±":
      type = "thisWeek";
      break;
    case "å¤§å®°åºœ":
      type = "dazaifu";
      break;
    default:
      type = "today";
  }

  try {
    const statement = await getStatement(type);

    console.log(
      "è¡¨ç¤ºå¯¾è±¡(type=2)",
      statement.transactions
        .filter(tx => String(tx.transactionType) === "2")
        .map(tx => tx.transactionDate)
    );

    const text = statement.transactions
      .filter(tx => String(tx.transactionType) === "2")
      .sort((a, b) => b.transactionDate.localeCompare(a.transactionDate))
      .slice(0, 5)
      .map(tx =>
        `ğŸ“… ${tx.transactionDate}\nğŸ’´ ${Math.abs(Number(tx.amount))}å††\nğŸ“ ${tx.remarks ?? "ï¼ˆæ‘˜è¦ãªã—ï¼‰"}`
      )
      .join("\n\n");

      await replyText(replyToken, text || "å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“");

      // çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
      delete userStatus[userId];
      return { statusCode: 200, body: "OK" };
  
    } catch (err) {
      console.error("å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      await replyText(replyToken, "å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
  
      delete userStatus[userId];
      return { statusCode: 500, body: "NG" };
    }
  }
  
